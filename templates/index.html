<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AssetDNA</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #2d3748;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            color: #6b7280;
            font-size: 1.1rem;
        }
        
        .layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
            min-height: calc(100vh - 200px);
        }
        
        .sidebar {
            background: #f8fafc;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #e2e8f0;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }
        
        .main-content {
            background: white;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #e2e8f0;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }
        
        select, input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            width: auto;
            margin: 0 5px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.2s;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .search-box {
            flex: 1;
            max-width: 300px;
            margin: 0;
        }
        
        .tree-container {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            min-height: 400px;
        }
        
        .tree-node {
            margin: 0;
            padding: 0;
            list-style: none;
        }
        
        .tree-item {
            margin: 5px 0;
            position: relative;
        }
        
        .tree-label {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            margin-bottom: 4px;
        }
        
        .tree-label:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: translateX(3px);
        }
        
        .tree-label.root {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 12px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .tree-label.category {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            font-weight: 600;
            font-size: 15px;
            margin-left: 20px;
            margin-bottom: 8px;
            box-shadow: 0 2px 8px rgba(72, 187, 120, 0.3);
        }
        
        .tree-label.environment {
            background: #e2e8f0;
            color: #2d3748;
            font-weight: 600;
            margin-left: 40px;
            margin-bottom: 6px;
            border-left: 4px solid #cbd5e0;
        }
        
        .tree-label.cis {
            background: #f7fafc;
            color: #4a5568;
            font-weight: 500;
            margin-left: 60px;
            margin-bottom: 4px;
            border-left: 3px solid #e2e8f0;
        }
        
        .tree-label.asset {
            background: white;
            color: #4a5568;
            margin-left: 80px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            cursor: grab;
        }
        
        .tree-label.asset:active {
            cursor: grabbing;
        }
        
        .tree-label.asset.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
            z-index: 1000;
        }
        
        .tree-label.asset:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        
        .tree-label.asset.selected {
            background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.25);
        }
        
        /* Enhanced drop target highlighting */
        .tree-label.environment.drag-over,
        .tree-label.cis.drag-over {
            background: linear-gradient(135deg, #667eea 0%, #5a67d8 100%) !important;
            color: white !important;
            border-color: #4c51bf !important;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4) !important;
            transform: scale(1.02);
            transition: all 0.2s ease;
        }
        
        .tree-label.environment.drag-over .tree-subtitle,
        .tree-label.cis.drag-over .tree-subtitle {
            color: rgba(255, 255, 255, 0.9) !important;
        }
        
        /* Drop zone indicator */
        .drop-indicator {
            border: 3px dashed #667eea;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            padding: 8px;
            margin: 4px 0;
            text-align: center;
            color: #667eea;
            font-weight: 600;
            font-size: 14px;
            display: none;
        }
        
        .drop-indicator.show {
            display: block;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }
        
        /* Auto-scroll container */
        .topology-container {
            max-height: 70vh;
            overflow-y: auto;
            position: relative;
        }
        
        .auto-scroll-zone {
            position: fixed;
            width: 100px;
            height: 100px;
            z-index: 999;
            pointer-events: none;
        }
        
        .auto-scroll-zone.top {
            top: 0;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .auto-scroll-zone.bottom {
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .auto-scroll-zone.left {
            left: 0;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .auto-scroll-zone.right {
            right: 0;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .tree-toggle {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        
        .tree-icon {
            width: 24px;
            height: 24px;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .tree-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .tree-title {
            font-weight: inherit;
            margin: 0;
        }
        
        .tree-subtitle {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 2px;
        }
        
        .tree-children {
            display: none;
            margin-left: 0;
            padding-left: 0;
            list-style: none;
        }
        
        .tree-children.expanded {
            display: block;
            animation: slideDown 0.3s ease-out;
        }
        
        .asset-actions {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 8px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: white;
            transition: all 0.2s;
        }
        
        .checkbox-item:hover {
            border-color: #667eea;
            background: #f8fafc;
        }
        
        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
            width: 16px;
            height: 16px;
        }
        
        .checkbox-item label {
            margin: 0;
            font-size: 14px;
            color: #374151;
            cursor: pointer;
        }
        
        .attribute-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin: 2px;
            white-space: nowrap;
        }
        
        .asset-badge {
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .asset-id-badge {
            background: #1a202c;
            color: #68d391;
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .timestamp-badge {
            background: #f3f4f6;
            color: #6b7280;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
            margin-left: 4px;
        }
        
        .timestamp-section {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e5e7eb;
            font-size: 12px;
            color: #6b7280;
        }
        
        .environment-badge {
            background: #48bb78;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .tree-stats {
            background: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.9);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: auto;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 18px;
            color: #6b7280;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #48bb78;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 1000;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background: #e53e3e;
            box-shadow: 0 4px 12px rgba(229, 62, 62, 0.3);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .close:hover {
            color: #667eea;
        }
        
        .asset-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px solid #cbd5e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .asset-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 1000px;
            }
        }
        
        @media (max-width: 1200px) {
            .layout {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .sidebar {
                max-height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-sitemap"></i> AssetDNA</h1>
            <p class="subtitle">Manage, organize, and track your infrastructure assets</p>
        </div>
        
        <div class="layout">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="controls">
                    <h3 style="color: #2d3748; margin: 0;">Asset Management</h3>
                </div>
                
                <!-- Add Asset Form -->
                <form id="assetForm">
                    <div class="form-group">
                        <label for="environment">Environment</label>
                        <select id="environment" required>
                            <option value="">Select Environment</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="cisGroup">CIS Group</label>
                        <select id="cisGroup" required>
                            <option value="">Select CIS Group</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Asset Attributes (Tags)</label>
                        <div id="attributeCheckboxes" class="checkbox-group">
                            <!-- Attributes will be loaded here -->
                        </div>
                        <small style="color: #6b7280; display: block; margin-top: 4px;">
                            Select one or more attributes that describe this asset
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label for="assetType">Asset Type</label>
                        <select id="assetType" required>
                            <option value="">Select Type</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="assetName">Asset Name</label>
                        <input type="text" id="assetName" placeholder="e.g., NSUSS-WEB-01" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="physicalLocation">Physical Location</label>
                        <input type="text" id="physicalLocation" placeholder="e.g., Rack 3A, Building 1" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="ipAddress">IP Address</label>
                        <input type="text" id="ipAddress" placeholder="192.168.1.100">
                    </div>
                    
                    <div class="form-group">
                        <label for="operatingSystem">Operating System</label>
                        <input type="text" id="operatingSystem" placeholder="e.g., Ubuntu 22.04 LTS">
                    </div>
                    
                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea id="description" rows="3" placeholder="Additional details..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="aircraftIdentical">
                            <input type="checkbox" id="aircraftIdentical" style="width: auto; margin-right: 8px;">
                            Aircraft Identical
                        </label>
                        <small style="color: #6b7280; display: block; margin-top: 4px;">
                            Check if this asset must be aircraft-identical hardware
                        </small>
                    </div>
                    
                    <button type="submit" class="btn">
                        <i class="fas fa-plus"></i> Add Asset
                    </button>
                </form>
                
                <button type="button" id="editMode" class="btn btn-success" style="margin-top: 10px;">
                    <i class="fas fa-edit"></i> <span>Enable Edit Mode</span>
                </button>
            </div>
            
            <!-- Main Content -->
            <div class="main-content">
                <div class="tabs">
                    <div class="tab active" onclick="showTab('topology')">
                        <i class="fas fa-sitemap"></i> Topology
                    </div>
                    <div class="tab" onclick="showTab('assets')">
                        <i class="fas fa-list"></i> Asset List
                    </div>
                    <div class="tab" onclick="showTab('search')">
                        <i class="fas fa-search"></i> Search
                    </div>
                    <div class="tab" onclick="showTab('admin')">
                        <i class="fas fa-cog"></i> Admin
                    </div>
                </div>
                
                <!-- Topology View -->
                <div id="topology" class="tab-content active">
                    <div class="controls">
                        <h3 style="margin: 0;">Interactive Topology</h3>
                        <div>
                            <button onclick="exportJson()" class="btn btn-success btn-small">
                                <i class="fas fa-download"></i> Export JSON
                            </button>
                            <button onclick="exportJsonl()" class="btn btn-success btn-small">
                                <i class="fas fa-download"></i> Export JSONL
                            </button>
                            <button onclick="loadTopology()" class="btn btn-small">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="topology-container">
                        <!-- Auto-scroll zones -->
                        <div class="auto-scroll-zone top" id="autoScrollTop"></div>
                        <div class="auto-scroll-zone bottom" id="autoScrollBottom"></div>
                        <div class="auto-scroll-zone left" id="autoScrollLeft"></div>
                        <div class="auto-scroll-zone right" id="autoScrollRight"></div>
                        
                        <div id="topologyTree" class="tree-container">
                            <div class="loading">
                                <i class="fas fa-spinner fa-spin"></i> Loading topology...
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Asset List View -->
                <div id="assets" class="tab-content">
                    <div class="controls">
                        <h3 style="margin: 0;">Asset List</h3>
                        <input type="text" id="searchAssets" class="search-box" placeholder="Search assets...">
                    </div>
                    <div id="assetList">
                        <div class="loading">Loading assets...</div>
                    </div>
                </div>
                
                <!-- Search View -->
                <div id="search" class="tab-content">
                    <div class="controls">
                        <h3 style="margin: 0;">Advanced Search</h3>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <select id="filterEnvironment">
                            <option value="">All Environments</option>
                        </select>
                        <select id="filterCisGroup">
                            <option value="">All CIS Groups</option>
                        </select>
                        <select id="filterType">
                            <option value="">All Types</option>
                        </select>
                        <input type="text" id="filterSearch" placeholder="Search text...">
                    </div>
                    <div id="searchResults">
                        <div class="loading">Enter search criteria above</div>
                    </div>
                </div>
                
                <!-- Admin View -->
                <div id="admin" class="tab-content">
                    <div class="controls">
                        <h3 style="margin: 0;">Administration</h3>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <!-- Environments Management -->
                        <div>
                            <h4 style="margin-bottom: 15px; color: #2d3748;">
                                <i class="fas fa-globe"></i> Environments (<span id="environmentCount">0</span>)
                            </h4>
                            <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                                <div style="flex: 1; position: relative;">
                                    <input type="text" id="environmentSearch" placeholder="Search environments..." 
                                           style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                                    <i class="fas fa-search" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #6b7280;"></i>
                                </div>
                                <button onclick="showAddEnvironmentModal()" class="btn btn-success btn-small">
                                    <i class="fas fa-plus"></i> Add Environment
                                </button>
                            </div>
                            <div id="environmentsList">
                                <div class="loading">Loading environments...</div>
                            </div>
                        </div>
                        
                        <!-- CIS Groups Management -->
                        <div>
                            <h4 style="margin-bottom: 15px; color: #2d3748;">
                                <i class="fas fa-folder"></i> CIS Groups (<span id="cisGroupCount">0</span>)
                            </h4>
                            <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                                <div style="flex: 1; position: relative;">
                                    <input type="text" id="cisGroupSearch" placeholder="Search CIS groups..." 
                                           style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                                    <i class="fas fa-search" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #6b7280;"></i>
                                </div>
                                <button onclick="showAddCisGroupModal()" class="btn btn-success btn-small">
                                    <i class="fas fa-plus"></i> Add CIS Group
                                </button>
                            </div>
                            <div id="cisGroupsList">
                                <div class="loading">Loading CIS groups...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Asset Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Asset</h3>
                <span class="close">&times;</span>
            </div>
            <form id="editAssetForm">
                <input type="hidden" id="editAssetId">
                <div class="form-group">
                    <label for="editEnvironment">Environment</label>
                    <select id="editEnvironment" required>
                        <option value="">Select Environment</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Asset Attributes</label>
                    <div id="editAttributeCheckboxes" class="checkbox-group">
                        <!-- Attributes will be loaded here -->
                    </div>
                    <small style="color: #6b7280; display: block; margin-top: 4px;">
                        Select one or more attributes that describe this asset
                    </small>
                </div>
                
                <div class="form-group">
                    <label for="editAssetType">Asset Type</label>
                    <select id="editAssetType" required>
                        <option value="">Select Type</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="editAssetName">Asset Name</label>
                    <input type="text" id="editAssetName" required>
                </div>
                
                <div class="form-group">
                    <label for="editPhysicalLocation">Physical Location</label>
                    <input type="text" id="editPhysicalLocation" required>
                </div>
                
                <div class="form-group">
                    <label for="editIpAddress">IP Address</label>
                    <input type="text" id="editIpAddress">
                </div>
                
                <div class="form-group">
                    <label for="editOperatingSystem">Operating System</label>
                    <input type="text" id="editOperatingSystem">
                </div>
                
                <div class="form-group">
                    <label for="editDescription">Description</label>
                    <textarea id="editDescription" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="editAircraftIdentical">
                        <input type="checkbox" id="editAircraftIdentical" style="width: auto; margin-right: 8px;">
                        Aircraft Identical
                    </label>
                    <small style="color: #6b7280; display: block; margin-top: 4px;">
                        Check if this asset must be aircraft-identical hardware
                    </small>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-danger btn-small" onclick="deleteAsset()">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add Environment Modal -->
    <div id="addEnvironmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Environment</h3>
                <span class="close">&times;</span>
            </div>
            <form id="addEnvironmentForm">
                <div class="form-group">
                    <label for="newEnvironmentName">Environment Name</label>
                    <input type="text" id="newEnvironmentName" required>
                </div>
                
                <div class="form-group">
                    <label for="newEnvironmentCategory">Category</label>
                    <input type="text" id="newEnvironmentCategory" placeholder="e.g., PROD, DEV, TEST, LABS" required>
                </div>
                
                <div class="form-group">
                    <label for="newEnvironmentDescription">Description</label>
                    <textarea id="newEnvironmentDescription" rows="3"></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-plus"></i> Add Environment
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Environment Modal -->
    <div id="editEnvironmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Environment</h3>
                <span class="close">&times;</span>
            </div>
            <form id="editEnvironmentForm">
                <input type="hidden" id="editEnvironmentId">
                <div class="form-group">
                    <label for="editEnvironmentName">Environment Name</label>
                    <input type="text" id="editEnvironmentName" required>
                </div>
                
                <div class="form-group">
                    <label for="editEnvironmentCategory">Category</label>
                    <input type="text" id="editEnvironmentCategory" placeholder="e.g., PROD, DEV, TEST, LABS" required>
                </div>
                
                <div class="form-group">
                    <label for="editEnvironmentDescription">Description</label>
                    <textarea id="editEnvironmentDescription" rows="3"></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Update Environment
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add CIS Group Modal -->
    <div id="addCisGroupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add CIS Group</h3>
                <span class="close">&times;</span>
            </div>
            <form id="addCisGroupForm">
                <div class="form-group">
                    <label for="newCisGroupName">CIS Group Name</label>
                    <input type="text" id="newCisGroupName" required>
                </div>
                
                <div class="form-group">
                    <label for="newCisGroupDescription">Description</label>
                    <textarea id="newCisGroupDescription" rows="3"></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-plus"></i> Add CIS Group
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit CIS Group Modal -->
    <div id="editCisGroupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit CIS Group</h3>
                <span class="close">&times;</span>
            </div>
            <form id="editCisGroupForm">
                <input type="hidden" id="editCisGroupId">
                <div class="form-group">
                    <label for="editCisGroupName">CIS Group Name</label>
                    <input type="text" id="editCisGroupName" required>
                </div>
                
                <div class="form-group">
                    <label for="editCisGroupDescription">Description</label>
                    <textarea id="editCisGroupDescription" rows="3"></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Update CIS Group
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Notification -->
    <div id="notification" class="notification"></div>
    
    <script>
        // Application state
        let editModeEnabled = false;
        let currentTopology = {};
        let allAssets = [];
        let environments = [];
        let attributes = [];
        let assetTypes = [];
        
        // Utility function for debouncing
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Utility function to format timestamps
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            
            try {
                const date = new Date(timestamp);
                if (isNaN(date.getTime())) return 'Invalid Date';
                
                const now = new Date();
                const diffMs = now - date;
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffMinutes = Math.floor(diffMs / (1000 * 60));
                
                let timeAgo = '';
                if (diffDays > 0) {
                    timeAgo = `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
                } else if (diffHours > 0) {
                    timeAgo = `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
                } else if (diffMinutes > 0) {
                    timeAgo = `${diffMinutes} minute${diffMinutes > 1 ? 's' : ''} ago`;
                } else {
                    timeAgo = 'Just now';
                }
                
                // Get timezone abbreviation
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const timezoneAbbr = new Intl.DateTimeFormat('en', {
                    timeZoneName: 'short'
                }).formatToParts(date).find(part => part.type === 'timeZoneName')?.value || '';
                
                return `${date.toLocaleDateString()} ${date.toLocaleTimeString()} ${timezoneAbbr} (${timeAgo})`;
            } catch (error) {
                return 'Invalid Date';
            }
        }
        
        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            loadTopology();
            loadAssets();
            loadEnvironments();
            loadCisGroups();
            loadAttributes();
            loadAssetTypes();
            setupEventListeners();
            loadFilterOptions();
        });
        
        // Event listeners
        function setupEventListeners() {
            document.getElementById('assetForm').addEventListener('submit', handleAddAsset);
            document.getElementById('editAssetForm').addEventListener('submit', handleEditAsset);
            document.getElementById('addEnvironmentForm').addEventListener('submit', handleAddEnvironment);
            document.getElementById('editEnvironmentForm').addEventListener('submit', handleEditEnvironment);
            document.getElementById('addCisGroupForm').addEventListener('submit', handleAddCisGroup);
            document.getElementById('editCisGroupForm').addEventListener('submit', handleEditCisGroup);
            document.getElementById('editMode').addEventListener('click', toggleEditMode);
            
            // Search functionality
            document.getElementById('environmentSearch')?.addEventListener('input', debounce(renderEnvironmentsList, 300));
            document.getElementById('cisGroupSearch')?.addEventListener('input', debounce(renderCisGroupsList, 300));
            document.getElementById('searchAssets').addEventListener('input', handleAssetSearch);
            document.getElementById('filterEnvironment').addEventListener('change', handleAdvancedSearch);
            document.getElementById('filterCisGroup').addEventListener('change', handleAdvancedSearch);
            document.getElementById('filterType').addEventListener('change', handleAdvancedSearch);
            document.getElementById('filterSearch').addEventListener('input', handleAdvancedSearch);
            
            // Close modal event listeners
            document.querySelectorAll('.close').forEach(closeBtn => {
                closeBtn.addEventListener('click', function() {
                    this.closest('.modal').style.display = 'none';
                });
            });
            
            window.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.style.display = 'none';
                }
            });
        }
        
        // API calls
        async function apiCall(url, options = {}) {
            try {
                console.log('Making API call to:', url, 'with options:', options);
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (!response.ok) {
                    // Try to get error message from response
                    let errorMessage = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        console.log('Error data:', errorData);
                        if (errorData.error) {
                            errorMessage = errorData.error;
                        }
                    } catch (e) {
                        // If we can't parse JSON, use default message
                        console.error('Failed to parse error response:', e);
                    }
                    console.log('Throwing error with message:', errorMessage);
                    const error = new Error(errorMessage);
                    error.status = response.status;
                    throw error;
                }
                
                // For DELETE requests that return 204 (no content), don't try to parse JSON
                if (response.status === 204) {
                    console.log('API call successful (204 No Content)');
                    return null;
                }
                
                const result = await response.json();
                console.log('API call successful, result:', result);
                return result;
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }
        
        async function loadTopology() {
            try {
                currentTopology = await apiCall('/api/topology');
                renderTopology();
            } catch (error) {
                document.getElementById('topologyTree').innerHTML = 
                    '<div class="loading" style="color: #e53e3e;">Failed to load topology</div>';
            }
        }
        
        async function loadAssets() {
            try {
                allAssets = await apiCall('/api/assets');
                renderAssetList(allAssets);
            } catch (error) {
                document.getElementById('assetList').innerHTML = 
                    '<div class="loading" style="color: #e53e3e;">Failed to load assets</div>';
            }
        }
        
        async function loadEnvironments() {
            try {
                environments = await apiCall('/api/environments');
                updateEnvironmentSelects();
                renderEnvironmentsList();
            } catch (error) {
                console.error('Failed to load environments:', error);
            }
        }
        
        async function loadAttributes() {
            try {
                attributes = await apiCall('/api/attributes');
                updateAttributeCheckboxes();
            } catch (error) {
                console.error('Failed to load attributes:', error);
            }
        }
        
        async function loadCisGroups() {
            try {
                cisGroups = await apiCall('/api/cis-groups');
                updateCisGroupSelects();
                renderCisGroupsList();
            } catch (error) {
                console.error('Failed to load CIS groups:', error);
            }
        }
        
        async function loadAssetTypes() {
            try {
                assetTypes = await apiCall('/api/asset-types');
                updateAssetTypeSelects();
            } catch (error) {
                console.error('Failed to load asset types:', error);
            }
        }
        
        async function handleAddAsset(event) {
            event.preventDefault();
            
            // Get selected attributes
            const selectedAttributes = [];
            document.querySelectorAll('#attributeCheckboxes input[type="checkbox"]:checked').forEach(checkbox => {
                selectedAttributes.push(checkbox.value);
            });
            
            console.log('Selected attributes:', selectedAttributes);
            
            const assetData = {
                environment: document.getElementById('environment').value,
                cisGroup: document.getElementById('cisGroup').value,
                attributes: selectedAttributes,
                type: document.getElementById('assetType').value,
                name: document.getElementById('assetName').value,
                location: document.getElementById('physicalLocation').value,
                ipAddress: document.getElementById('ipAddress').value,
                os: document.getElementById('operatingSystem').value,
                description: document.getElementById('description').value,
                aircraftIdentical: document.getElementById('aircraftIdentical').checked
            };
            
            console.log('Asset data to send:', assetData);
            
            try {
                const response = await apiCall('/api/assets', {
                    method: 'POST',
                    body: JSON.stringify(assetData)
                });
                
                console.log('Asset created:', response);
                showNotification('Asset added successfully!');
                event.target.reset();
                // Clear checkboxes
                document.querySelectorAll('#attributeCheckboxes input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                loadTopology();
                loadAssets();
            } catch (error) {
                console.error('Failed to add asset:', error);
                showNotification('Failed to add asset', 'error');
            }
        }
        
        async function handleEditAsset(event) {
            event.preventDefault();
            
            // Get selected attributes
            const selectedAttributes = [];
            document.querySelectorAll('#editAttributeCheckboxes input[type="checkbox"]:checked').forEach(checkbox => {
                selectedAttributes.push(checkbox.value);
            });
            
            const assetId = document.getElementById('editAssetId').value;
            const assetData = {
                environment: document.getElementById('editEnvironment').value,
                attributes: selectedAttributes,
                type: document.getElementById('editAssetType').value,
                name: document.getElementById('editAssetName').value,
                location: document.getElementById('editPhysicalLocation').value,
                ipAddress: document.getElementById('editIpAddress').value,
                os: document.getElementById('editOperatingSystem').value,
                description: document.getElementById('editDescription').value,
                aircraftIdentical: document.getElementById('editAircraftIdentical').checked
            };
            
            console.log('Updating asset with data:', assetData);
            
            try {
                const response = await apiCall(`/api/assets/${assetId}`, {
                    method: 'PUT',
                    body: JSON.stringify(assetData)
                });
                
                console.log('Asset updated:', response);
                showNotification('Asset updated successfully!');
                closeModal();
                loadTopology();
                loadAssets();
            } catch (error) {
                console.error('Failed to update asset:', error);
                showNotification('Failed to update asset', 'error');
            }
        }
        
        async function deleteAsset() {
            const assetId = document.getElementById('editAssetId').value;
            
            if (!confirm('Are you sure you want to delete this asset?')) {
                return;
            }
            
            try {
                await apiCall(`/api/assets/${assetId}`, {
                    method: 'DELETE'
                });
                
                showNotification('Asset deleted successfully!');
                closeModal();
                loadTopology();
                loadAssets();
            } catch (error) {
                showNotification('Failed to delete asset', 'error');
            }
        }
        
        function renderTopology() {
            const container = document.getElementById('topologyTree');
            
            if (!currentTopology.DEV && !currentTopology.LABS) {
                container.innerHTML = '<div class="loading">No topology data available</div>';
                return;
            }
            
            let totalAssets = 0;
            Object.values(currentTopology).forEach(category => {
                Object.values(category).forEach(environment => {
                    Object.values(environment).forEach(cisGroup => {
                        totalAssets += cisGroup.length;
                    });
                });
            });
            
            const html = `
                <ul class="tree-node">
                    <li class="tree-item">
                        <div class="tree-label root" onclick="toggleNode(this)">
                            <div class="tree-toggle"></div>
                            <div class="tree-icon"></div>
                            <div class="tree-content">
                                <div class="tree-title">Organizational Unit</div>
                                <div class="tree-subtitle">${totalAssets} assets total</div>
                            </div>
                            <div class="tree-stats">${totalAssets}</div>
                        </div>
                        <ul class="tree-children expanded">
                            ${renderCategories(currentTopology)}
                        </ul>
                    </li>
                </ul>
            `;
            
            container.innerHTML = html;
        }
        
        function renderCategories(topology) {
            return Object.entries(topology).map(([category, environments]) => {
                if (Object.keys(environments).length === 0) return '';
                
                let categoryAssetCount = 0;
                Object.values(environments).forEach(environment => {
                    Object.values(environment).forEach(cisGroup => {
                        categoryAssetCount += cisGroup.length;
                    });
                });
                
                const categoryIcon = category === 'LABS' ? '' : category === 'DEV' ? '' : '';
                
                return `
                    <li class="tree-item">
                        <div class="tree-label category" onclick="toggleNode(this)">
                            <div class="tree-toggle"></div>
                            <div class="tree-icon">${categoryIcon}</div>
                            <div class="tree-content">
                                <div class="tree-title">${category}</div>
                                <div class="tree-subtitle">${categoryAssetCount} assets</div>
                            </div>
                            <div class="tree-stats">${categoryAssetCount}</div>
                        </div>
                        <ul class="tree-children expanded">
                            ${renderEnvironments(environments)}
                        </ul>
                    </li>
                `;
            }).join('');
        }
        
        function renderEnvironments(environments) {
            // Sort environments to put UNASSIGNED at the bottom
            const sortedEnvironments = Object.entries(environments).sort(([envA], [envB]) => {
                if (envA === 'UNASSIGNED') return 1;  // UNASSIGNED goes to the bottom
                if (envB === 'UNASSIGNED') return -1; // UNASSIGNED goes to the bottom
                return envA.localeCompare(envB); // Normal alphabetical sorting for others
            });
            
            return sortedEnvironments.map(([env, cisGroups]) => {
                let envAssetCount = 0;
                Object.values(cisGroups).forEach(cisGroup => {
                    envAssetCount += cisGroup.length;
                });
                const envIcon = getEnvironmentIcon(env);
                
                return `
                    <li class="tree-item">
                        <div class="tree-label environment" onclick="toggleNode(this)" 
                             data-environment="${env}" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                            <div class="tree-toggle"></div>
                            <div class="tree-icon">${envIcon}</div>
                            <div class="tree-content">
                                <div class="tree-title">${env}</div>
                                <div class="tree-subtitle">${envAssetCount} assets</div>
                            </div>
                            <div class="tree-stats">${envAssetCount}</div>
                        </div>
                        <ul class="tree-children expanded">
                            ${renderCisGroups(cisGroups, env)}
                        </ul>
                    </li>
                `;
            }).join('');
        }
        
        function renderCisGroups(cisGroups, environment) {
            // Sort CIS groups to put OTHER at the bottom
            const sortedCisGroups = Object.entries(cisGroups).sort(([cisA], [cisB]) => {
                if (cisA === 'OTHER') return 1;  // OTHER goes to the bottom
                if (cisB === 'OTHER') return -1; // OTHER goes to the bottom
                return cisA.localeCompare(cisB); // Normal alphabetical sorting for others
            });
            
            return sortedCisGroups.map(([cis, assets]) => `
                <li class="tree-item">
                    <div class="tree-label cis" onclick="toggleNode(this)"
                         data-environment="${environment}" data-cis-group="${cis}"
                         ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <div class="tree-toggle"></div>
                        <div class="tree-icon"></div>
                        <div class="tree-content">
                            <div class="tree-title">${cis}</div>
                            <div class="tree-subtitle">${assets.length} assets</div>
                        </div>
                        <div class="tree-stats">${assets.length}</div>
                    </div>
                    <ul class="tree-children expanded">
                        ${renderAssets(assets)}
                    </ul>
                </li>
            `).join('');
        }
        
        function renderAssets(assets) {
            return assets.map(asset => {
                const attributeBadges = asset.attributes ? asset.attributes.map(attr => 
                    `<span class="attribute-badge">${attr}</span>`
                ).join('') : '';
                
                return `
                    <li class="tree-item">
                        <div class="tree-label asset" draggable="${editModeEnabled}" 
                             data-asset-id="${asset.id}" ondragstart="handleDragStart(event)" ondragend="handleDragEnd(event)"
                             onclick="editModeEnabled ? openEditModal('${asset.id}') : null">
                            <div class="tree-icon">${getAssetIcon(asset.type)}</div>
                            <div class="tree-content">
                                <div class="tree-title">${asset.name}</div>
                                <div class="tree-subtitle">${asset.type}  ${asset.location}</div>
                                ${attributeBadges ? `<div style="margin-top: 4px;">${attributeBadges}</div>` : ''}
                            </div>
                            <div class="asset-badge">${asset.type}</div>
                            <div class="asset-id-badge">${asset.id}</div>
                            ${asset.aircraftIdentical ? '<div class="asset-badge" style="background: #dc2626; color: white;">Aircraft Identical</div>' : ''}
                            ${editModeEnabled ? `
                                <div class="asset-actions">
                                    <button class="btn btn-small" onclick="event.stopPropagation(); openEditModal('${asset.id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </li>
                `;
            }).join('');
        }
        
        function getEnvironmentIcon(env) {
            const icons = {
                'NSUSS/NMT SDE': '',
                'FLEP SDE': '',
                'MS1': '',
                'FLEP SIL': '',
                'ESM DBE': '',
                'CONNECT LAB': ''
            };
            return icons[env] || '';
        }
        
        function getAssetIcon(type) {
            const icons = {
                'Server': '',
                'Workstation': '',
                'Laptop': '',
                'Network Device': '',
                'Storage': '',
                'Virtual Machine': '',
                'Container': '',
                'Other': ''
            };
            return icons[type] || '';
        }
        
        let draggedAsset = null;
        let dragStartTime = null;
        let autoScrollInterval = null;
        let lastDropTarget = null;
        let currentMouseY = 0;
        
        function handleDragStart(event) {
            if (!editModeEnabled) return;
            
            draggedAsset = event.target.closest('.tree-label').dataset.assetId;
            dragStartTime = Date.now();
            event.target.closest('.tree-label').classList.add('dragging');
            
            // Start auto-scroll detection
            startAutoScrollDetection();
        }
        
        function handleDragOver(event) {
            if (!editModeEnabled || !draggedAsset) return;
            
            event.preventDefault();
            const dropTarget = event.target.closest('.tree-label');
            
            // Remove previous drag-over class
            document.querySelectorAll('.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });
            
            // Add drag-over class to current target
            if (dropTarget && (dropTarget.classList.contains('environment') || dropTarget.classList.contains('cis'))) {
                dropTarget.classList.add('drag-over');
                lastDropTarget = dropTarget;
            }
        }
        
        function handleDragLeave(event) {
            if (!editModeEnabled || !draggedAsset) return;
            
            const dropTarget = event.target.closest('.tree-label');
            if (dropTarget) {
                dropTarget.classList.remove('drag-over');
            }
        }
        
        function handleDrop(event) {
            if (!editModeEnabled || !draggedAsset) return;
            
            event.preventDefault();
            const dropTarget = event.target.closest('.tree-label');
            
            // Clear all drag-over classes
            clearAllDragOverClasses();
            
            const environment = dropTarget.dataset.environment;
            const cisGroup = dropTarget.dataset.cisGroup;
            
            if (environment && draggedAsset) {
                // Store the original position for visual feedback
                const originalAsset = document.querySelector(`[data-asset-id="${draggedAsset}"]`);
                const originalParent = originalAsset ? originalAsset.closest('.tree-children') : null;
                
                moveAsset(draggedAsset, environment, cisGroup, originalParent);
            }
            
            // Clean up
            cleanupDragState();
        }
        
        function handleDragEnd(event) {
            if (!editModeEnabled || !draggedAsset) return;
            
            // Clear all drag-over classes
            clearAllDragOverClasses();
            
            // Clean up
            cleanupDragState();
        }
        
        function clearAllDragOverClasses() {
            document.querySelectorAll('.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });
        }
        
        function cleanupDragState() {
            document.querySelectorAll('.dragging').forEach(el => {
                el.classList.remove('dragging');
            });
            draggedAsset = null;
            dragStartTime = null;
            stopAutoScrollDetection();
        }
        
        function startAutoScrollDetection() {
            // Track mouse position during drag
            const dragOverHandler = function(e) {
                currentMouseY = e.clientY;
            };
            
            document.addEventListener('dragover', dragOverHandler, { passive: true });
            
            autoScrollInterval = setInterval(() => {
                const windowHeight = window.innerHeight;
                const scrollSpeed = 15;
                
                if (currentMouseY < 100) {
                    // Scroll up
                    window.scrollBy(0, -scrollSpeed);
                } else if (currentMouseY > windowHeight - 100) {
                    // Scroll down
                    window.scrollBy(0, scrollSpeed);
                }
            }, 50);
            
            // Store the handler for cleanup
            window.currentDragOverHandler = dragOverHandler;
        }
        
        function stopAutoScrollDetection() {
            if (autoScrollInterval) {
                clearInterval(autoScrollInterval);
                autoScrollInterval = null;
            }
            
            // Remove the drag over handler
            if (window.currentDragOverHandler) {
                document.removeEventListener('dragover', window.currentDragOverHandler);
                window.currentDragOverHandler = null;
            }
        }
        
        async function moveAsset(assetId, environment, cisGroup, originalParent) {
            try {
                // Show immediate visual feedback
                const assetElement = document.querySelector(`[data-asset-id="${assetId}"]`);
                if (assetElement) {
                    assetElement.style.opacity = '0.3';
                    assetElement.style.transform = 'scale(0.95)';
                }
                
                const response = await apiCall('/api/assets/move', {
                    method: 'POST',
                    body: JSON.stringify({
                        assetId: assetId,
                        environment: environment,
                        cisGroup: cisGroup
                    })
                });
                
                // Show success notification with details
                const asset = response;
                const targetLocation = cisGroup ? `${environment} > ${cisGroup}` : environment;
                showNotification(`Asset "${asset.name}" moved to ${targetLocation}`, 'success');
                
                // Update only the affected sections instead of full reload
                updateTopologyAfterMove(assetId, environment, cisGroup, originalParent);
                
            } catch (error) {
                showNotification('Failed to move asset', 'error');
                
                // Restore original appearance on error
                if (assetElement) {
                    assetElement.style.opacity = '';
                    assetElement.style.transform = '';
                }
            }
        }
        
        function updateTopologyAfterMove(assetId, newEnvironment, newCisGroup, originalParent) {
            // Find the asset in current topology data
            const asset = allAssets.find(a => a.id === assetId);
            if (!asset) return;
            
            // Update the asset's position in our local data
            asset.environment = newEnvironment;
            if (newCisGroup) {
                asset.cisGroup = newCisGroup;
            }
            
            // Update the visual representation
            const assetElement = document.querySelector(`[data-asset-id="${assetId}"]`);
            if (assetElement) {
                // Remove from original location
                assetElement.remove();
                
                // Find the new target CIS group and add the asset there
                const targetCisGroup = document.querySelector(`[data-environment="${newEnvironment}"][data-cis-group="${newCisGroup}"]`);
                if (targetCisGroup) {
                    const targetChildren = targetCisGroup.nextElementSibling;
                    if (targetChildren && targetChildren.classList.contains('tree-children')) {
                        // Create new asset element
                        const newAssetElement = createAssetElement(asset);
                        targetChildren.appendChild(newAssetElement);
                        
                        // Update asset counts
                        updateAssetCounts();
                    }
                } else {
                    // If the target location doesn't exist in the current view, reload the topology
                    loadTopology();
                }
            }
        }
        
        function createAssetElement(asset) {
            const attributeBadges = asset.attributes ? asset.attributes.map(attr => 
                `<span class="attribute-badge">${attr}</span>`
            ).join('') : '';
            
            const li = document.createElement('li');
            li.className = 'tree-item';
            li.innerHTML = `
                <div class="tree-label asset" draggable="${editModeEnabled}" 
                     data-asset-id="${asset.id}" ondragstart="handleDragStart(event)" ondragend="handleDragEnd(event)"
                     onclick="editModeEnabled ? openEditModal('${asset.id}') : null">
                    <div class="tree-icon">${getAssetIcon(asset.type)}</div>
                    <div class="tree-content">
                        <div class="tree-title">${asset.name}</div>
                        <div class="tree-subtitle">${asset.type}  ${asset.location}</div>
                        ${attributeBadges ? `<div style="margin-top: 4px;">${attributeBadges}</div>` : ''}
                    </div>
                    <div class="asset-badge">${asset.type}</div>
                    <div class="asset-id-badge">${asset.id}</div>
                    ${asset.aircraftIdentical ? '<div class="asset-badge" style="background: #dc2626; color: white;">Aircraft Identical</div>' : ''}
                    ${editModeEnabled ? `
                        <div class="asset-actions">
                            <button class="btn btn-small" onclick="event.stopPropagation(); openEditModal('${asset.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
            return li;
        }
        
        function updateAssetCounts() {
            // Update environment counts
            document.querySelectorAll('.tree-label.environment').forEach(env => {
                const envName = env.dataset.environment;
                const assetCount = env.querySelectorAll('.tree-label.asset').length;
                const subtitle = env.querySelector('.tree-subtitle');
                if (subtitle) {
                    subtitle.textContent = `${assetCount} assets`;
                }
                const stats = env.querySelector('.tree-stats');
                if (stats) {
                    stats.textContent = assetCount;
                }
            });
            
            // Update category counts
            document.querySelectorAll('.tree-label.category').forEach(category => {
                const categoryAssets = category.closest('.tree-item').querySelectorAll('.tree-label.asset').length;
                const subtitle = category.querySelector('.tree-subtitle');
                if (subtitle) {
                    subtitle.textContent = `${categoryAssets} assets`;
                }
                const stats = category.querySelector('.tree-stats');
                if (stats) {
                    stats.textContent = categoryAssets;
                }
            });
        }
        
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'search') {
                handleAdvancedSearch();
            }
        }
        
        function toggleNode(element) {
            const children = element.nextElementSibling;
            const toggle = element.querySelector('.tree-toggle');
            
            if (children && children.classList.contains('tree-children')) {
                if (children.classList.contains('expanded')) {
                    children.classList.remove('expanded');
                    toggle.textContent = '+';
                } else {
                    children.classList.add('expanded');
                    toggle.textContent = '';
                }
            }
        }
        
        function toggleEditMode() {
            editModeEnabled = !editModeEnabled;
            const button = document.getElementById('editMode');
            const span = button.querySelector('span');
            
            if (editModeEnabled) {
                button.classList.remove('btn-success');
                button.classList.add('btn-danger');
                span.textContent = 'Disable Edit Mode';
                showNotification('Edit mode enabled - you can now drag assets and click to edit');
            } else {
                button.classList.remove('btn-danger');
                button.classList.add('btn-success');
                span.textContent = 'Enable Edit Mode';
                showNotification('Edit mode disabled');
            }
            
            loadTopology();
        }
        
        function openEditModal(assetId) {
            const asset = allAssets.find(a => a.id === assetId);
            if (!asset) return;
            
            document.getElementById('editAssetId').value = asset.id;
            document.getElementById('editEnvironment').value = asset.environment;
            document.getElementById('editAssetType').value = asset.type;
            document.getElementById('editAssetName').value = asset.name;
            document.getElementById('editPhysicalLocation').value = asset.location;
            document.getElementById('editIpAddress').value = asset.ipAddress || '';
            document.getElementById('editOperatingSystem').value = asset.os || '';
            document.getElementById('editDescription').value = asset.description || '';
            document.getElementById('editAircraftIdentical').checked = asset.aircraftIdentical || false;
            
            // Populate attribute checkboxes
            populateEditAttributeCheckboxes(asset.attributes || []);
            
            document.getElementById('editModal').style.display = 'block';
        }
        
        function populateEditAttributeCheckboxes(selectedAttributes) {
            const container = document.getElementById('editAttributeCheckboxes');
            if (!container) return;
            
            container.innerHTML = '';
            attributes.forEach(attr => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                const isChecked = selectedAttributes.includes(attr);
                div.innerHTML = `
                    <input type="checkbox" id="edit_attr_${attr.replace(/\s+/g, '_')}" value="${attr}" ${isChecked ? 'checked' : ''}>
                    <label for="edit_attr_${attr.replace(/\s+/g, '_')}">${attr}</label>
                `;
                container.appendChild(div);
            });
        }
        
        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }
        
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        function renderAssetList(assets) {
            const container = document.getElementById('assetList');
            
            if (assets.length === 0) {
                container.innerHTML = '<div class="loading">No assets found</div>';
                return;
            }
            
            const html = assets.map(asset => {
                const attributeBadges = asset.attributes ? asset.attributes.map(attr => 
                    `<span class="attribute-badge">${attr}</span>`
                ).join('') : '';
                
                return `
                    <div class="asset-card" onclick="openEditModal('${asset.id}')">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <div class="asset-id-badge">${asset.id}</div>
                            <div class="asset-badge">${asset.type}</div>
                            <div class="environment-badge">${asset.environment}</div>
                            ${asset.aircraftIdentical ? '<div class="asset-badge" style="background: #dc2626; color: white;">Aircraft Identical</div>' : ''}
                        </div>
                        <h4 style="margin: 0 0 5px 0; color: #2d3748;">${asset.name}</h4>
                        <div style="font-size: 14px; color: #4a5568; line-height: 1.5;">
                            <strong>Environment:</strong> ${asset.environment}<br>
                            <strong>Location:</strong> ${asset.location}<br>
                            ${asset.ipAddress ? `<strong>IP:</strong> ${asset.ipAddress}<br>` : ''}
                            ${asset.os ? `<strong>OS:</strong> ${asset.os}<br>` : ''}
                            ${attributeBadges ? `<strong>Attributes:</strong> ${attributeBadges}<br>` : ''}
                            ${asset.description ? `<strong>Description:</strong> ${asset.description}<br>` : ''}
                        </div>
                        <div class="timestamp-section">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span><i class="fas fa-calendar-plus"></i> <strong>Created:</strong> ${formatTimestamp(asset.createdAt)}</span>
                                <span><i class="fas fa-calendar-check"></i> <strong>Updated:</strong> ${formatTimestamp(asset.updatedAt)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }
        
        function handleAssetSearch(event) {
            const searchTerm = event.target.value.toLowerCase();
            const filteredAssets = allAssets.filter(asset => 
                asset.name.toLowerCase().includes(searchTerm) ||
                asset.description?.toLowerCase().includes(searchTerm) ||
                asset.location.toLowerCase().includes(searchTerm) ||
                asset.environment.toLowerCase().includes(searchTerm) ||
                (asset.attributes && asset.attributes.some(attr => attr.toLowerCase().includes(searchTerm)))
            );
            renderAssetList(filteredAssets);
        }
        
        async function handleAdvancedSearch() {
            const environment = document.getElementById('filterEnvironment').value;
            const cisGroup = document.getElementById('filterCisGroup').value;
            const type = document.getElementById('filterType').value;
            const search = document.getElementById('filterSearch').value;
            
            const params = new URLSearchParams();
            if (environment) params.append('environment', environment);
            if (cisGroup) params.append('cis_group', cisGroup);
            if (type) params.append('type', type);
            if (search) params.append('search', search);
            
            try {
                const assets = await apiCall(`/api/assets?${params}`);
                
                const container = document.getElementById('searchResults');
                if (assets.length === 0) {
                    container.innerHTML = '<div class="loading">No assets match your criteria</div>';
                } else {
                    const html = assets.map(asset => `
                        <div class="asset-card" onclick="openEditModal('${asset.id}')">
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <div class="asset-id-badge">${asset.id}</div>
                                <div class="asset-badge">${asset.type}</div>
                                <div class="environment-badge">${asset.environment}</div>
                            </div>
                            <h4 style="margin: 0 0 5px 0; color: #2d3748;">${asset.name}</h4>
                            <div style="font-size: 14px; color: #4a5568; line-height: 1.5;">
                                <strong>Environment:</strong> ${asset.environment}<br>
                                <strong>CIS Group:</strong> ${asset.cisGroup}<br>
                                <strong>Location:</strong> ${asset.location}<br>
                                ${asset.ipAddress ? `<strong>IP:</strong> ${asset.ipAddress}<br>` : ''}
                                ${asset.os ? `<strong>OS:</strong> ${asset.os}<br>` : ''}
                                ${asset.description ? `<strong>Description:</strong> ${asset.description}<br>` : ''}
                            </div>
                            <div class="timestamp-section">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span><i class="fas fa-calendar-plus"></i> <strong>Created:</strong> ${formatTimestamp(asset.createdAt)}</span>
                                    <span><i class="fas fa-calendar-check"></i> <strong>Updated:</strong> ${formatTimestamp(asset.updatedAt)}</span>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    container.innerHTML = html;
                }
            } catch (error) {
                document.getElementById('searchResults').innerHTML = 
                    '<div class="loading" style="color: #e53e3e;">Search failed</div>';
            }
        }
        
        async function loadFilterOptions() {
            try {
                const environments = [...new Set(allAssets.map(a => a.environment))];
                const cisGroups = [...new Set(allAssets.map(a => a.cisGroup))];
                const types = [...new Set(allAssets.map(a => a.type))];
                
                const envSelect = document.getElementById('filterEnvironment');
                const cisSelect = document.getElementById('filterCisGroup');
                const typeSelect = document.getElementById('filterType');
                
                environments.forEach(env => {
                    const option = document.createElement('option');
                    option.value = env;
                    option.textContent = env;
                    envSelect.appendChild(option);
                });
                
                cisGroups.forEach(cis => {
                    const option = document.createElement('option');
                    option.value = cis;
                    option.textContent = cis;
                    cisSelect.appendChild(option);
                });
                
                types.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    typeSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load filter options:', error);
            }
        }
        
        function exportJson() {
            window.open('/api/export/json', '_blank');
        }
        
        function updateEnvironmentSelects() {
            const selects = ['environment', 'editEnvironment', 'filterEnvironment'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    // Keep the first option (placeholder)
                    const placeholder = select.options[0];
                    select.innerHTML = '';
                    select.appendChild(placeholder);
                    
                    environments.forEach(env => {
                        const option = document.createElement('option');
                        option.value = env.name;
                        option.textContent = env.name;
                        select.appendChild(option);
                    });
                }
            });
        }
        
        function updateAttributeCheckboxes() {
            const container = document.getElementById('attributeCheckboxes');
            if (!container) {
                console.error('Attribute checkboxes container not found');
                return;
            }
            
            container.innerHTML = '';
            console.log('Loading attributes:', attributes);
            
            attributes.forEach(attr => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                div.innerHTML = `
                    <input type="checkbox" id="attr_${attr.replace(/\s+/g, '_')}" value="${attr}">
                    <label for="attr_${attr.replace(/\s+/g, '_')}">${attr}</label>
                `;
                container.appendChild(div);
            });
        }
        
        function updateCisGroupSelects() {
            const selects = ['cisGroup', 'editCisGroup', 'filterCisGroup'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    // Keep the first option (placeholder)
                    const placeholder = select.options[0];
                    select.innerHTML = '';
                    select.appendChild(placeholder);
                    
                    cisGroups.forEach(group => {
                        const option = document.createElement('option');
                        option.value = group.name;
                        option.textContent = group.name;
                        select.appendChild(option);
                    });
                }
            });
        }
        
        function updateAssetTypeSelects() {
            const selects = ['assetType', 'editAssetType', 'filterType'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    // Keep the first option (placeholder)
                    const placeholder = select.options[0];
                    select.innerHTML = '';
                    select.appendChild(placeholder);
                    
                    assetTypes.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type;
                        select.appendChild(option);
                    });
                }
            });
        }
        
        function renderEnvironmentsList() {
            const container = document.getElementById('environmentsList');
            const countElement = document.getElementById('environmentCount');
            if (!container) return;
            
            // Get search term
            const searchTerm = document.getElementById('environmentSearch')?.value?.toLowerCase() || '';
            
            // Filter environments based on search term
            const filteredEnvironments = environments.filter(env => 
                env.name.toLowerCase().includes(searchTerm) ||
                env.category.toLowerCase().includes(searchTerm) ||
                (env.description && env.description.toLowerCase().includes(searchTerm))
            );
            
            // Sort environments to put UNASSIGNED at the bottom
            const sortedEnvironments = filteredEnvironments.sort((envA, envB) => {
                if (envA.name === 'UNASSIGNED') return 1;  // UNASSIGNED goes to the bottom
                if (envB.name === 'UNASSIGNED') return -1; // UNASSIGNED goes to the bottom
                return envA.name.localeCompare(envB.name); // Normal alphabetical sorting for others
            });
            
            // Update count
            if (countElement) {
                countElement.textContent = sortedEnvironments.length;
            }
            
            if (sortedEnvironments.length === 0) {
                container.innerHTML = searchTerm ? 
                    '<div class="loading">No environments match your search</div>' :
                    '<div class="loading">No environments found</div>';
                return;
            }
            
            const html = sortedEnvironments.map(env => `
                <div class="asset-card" style="margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h5 style="margin: 0 0 5px 0; color: #2d3748;">${env.name}</h5>
                            <div style="font-size: 12px; color: #6b7280;">
                                <span class="environment-badge">${env.category}</span>
                                ${env.description ? `<br>${env.description}` : ''}
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-primary btn-small" onclick="editEnvironment(${env.id})" style="margin-right: 5px;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-small" onclick="deleteEnvironment(${env.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }
        
        function renderCisGroupsList() {
            const container = document.getElementById('cisGroupsList');
            const countElement = document.getElementById('cisGroupCount');
            if (!container) return;
            
            // Get search term
            const searchTerm = document.getElementById('cisGroupSearch')?.value?.toLowerCase() || '';
            
            // Filter CIS groups based on search term
            const filteredCisGroups = cisGroups.filter(group => 
                group.name.toLowerCase().includes(searchTerm) ||
                (group.description && group.description.toLowerCase().includes(searchTerm))
            );
            
            // Sort CIS groups to put OTHER at the bottom
            const sortedCisGroups = filteredCisGroups.sort((groupA, groupB) => {
                if (groupA.name === 'OTHER') return 1;  // OTHER goes to the bottom
                if (groupB.name === 'OTHER') return -1; // OTHER goes to the bottom
                return groupA.name.localeCompare(groupB.name); // Normal alphabetical sorting for others
            });
            
            // Update count
            if (countElement) {
                countElement.textContent = sortedCisGroups.length;
            }
            
            if (sortedCisGroups.length === 0) {
                container.innerHTML = searchTerm ? 
                    '<div class="loading">No CIS groups match your search</div>' :
                    '<div class="loading">No CIS groups found</div>';
                return;
            }
            
            const html = sortedCisGroups.map(group => `
                <div class="asset-card" style="margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h5 style="margin: 0 0 5px 0; color: #2d3748;">${group.name}</h5>
                            <div style="font-size: 12px; color: #6b7280;">
                                ${group.description ? group.description : ''}
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-primary btn-small" onclick="editCisGroup(${group.id})" style="margin-right: 5px;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-small" onclick="deleteCisGroup(${group.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }
        
        function showAddEnvironmentModal() {
            document.getElementById('addEnvironmentModal').style.display = 'block';
        }
        
        function showAddCisGroupModal() {
            document.getElementById('addCisGroupModal').style.display = 'block';
        }
        
        async function handleAddEnvironment(event) {
            event.preventDefault();
            
            const environmentData = {
                name: document.getElementById('newEnvironmentName').value,
                category: document.getElementById('newEnvironmentCategory').value,
                description: document.getElementById('newEnvironmentDescription').value
            };
            
            try {
                await apiCall('/api/environments', {
                    method: 'POST',
                    body: JSON.stringify(environmentData)
                });
                
                showNotification('Environment added successfully!');
                event.target.reset();
                document.getElementById('addEnvironmentModal').style.display = 'none';
                loadEnvironments();
            } catch (error) {
                showNotification('Failed to add environment', 'error');
            }
        }

        function editEnvironment(environmentId) {
            const environment = environments.find(env => env.id === environmentId);
            if (!environment) {
                showNotification('Environment not found', 'error');
                return;
            }
            
            document.getElementById('editEnvironmentId').value = environment.id;
            document.getElementById('editEnvironmentName').value = environment.name;
            document.getElementById('editEnvironmentCategory').value = environment.category;
            document.getElementById('editEnvironmentDescription').value = environment.description || '';
            
            document.getElementById('editEnvironmentModal').style.display = 'block';
        }

        async function handleEditEnvironment(event) {
            event.preventDefault();
            
            const environmentId = document.getElementById('editEnvironmentId').value;
            const environmentData = {
                name: document.getElementById('editEnvironmentName').value,
                category: document.getElementById('editEnvironmentCategory').value,
                description: document.getElementById('editEnvironmentDescription').value
            };
            
            try {
                await apiCall(`/api/environments/${environmentId}`, {
                    method: 'PUT',
                    body: JSON.stringify(environmentData)
                });
                
                showNotification('Environment updated successfully!');
                document.getElementById('editEnvironmentModal').style.display = 'none';
                loadEnvironments();
                loadTopology(); // Refresh topology to reflect changes
            } catch (error) {
                showNotification('Failed to update environment', 'error');
            }
        }
        
        async function handleAddCisGroup(event) {
            event.preventDefault();
            
            const cisGroupData = {
                name: document.getElementById('newCisGroupName').value,
                description: document.getElementById('newCisGroupDescription').value
            };
            
            try {
                await apiCall('/api/cis-groups', {
                    method: 'POST',
                    body: JSON.stringify(cisGroupData)
                });
                
                showNotification('CIS Group added successfully!');
                event.target.reset();
                document.getElementById('addCisGroupModal').style.display = 'none';
                loadCisGroups();
            } catch (error) {
                showNotification('Failed to add CIS group', 'error');
            }
        }

        function editCisGroup(cisGroupId) {
            const cisGroup = cisGroups.find(group => group.id === cisGroupId);
            if (!cisGroup) {
                showNotification('CIS Group not found', 'error');
                return;
            }
            
            document.getElementById('editCisGroupId').value = cisGroup.id;
            document.getElementById('editCisGroupName').value = cisGroup.name;
            document.getElementById('editCisGroupDescription').value = cisGroup.description || '';
            
            document.getElementById('editCisGroupModal').style.display = 'block';
        }

        async function handleEditCisGroup(event) {
            event.preventDefault();
            
            const cisGroupId = document.getElementById('editCisGroupId').value;
            const cisGroupData = {
                name: document.getElementById('editCisGroupName').value,
                description: document.getElementById('editCisGroupDescription').value
            };
            
            try {
                await apiCall(`/api/cis-groups/${cisGroupId}`, {
                    method: 'PUT',
                    body: JSON.stringify(cisGroupData)
                });
                
                showNotification('CIS Group updated successfully!');
                document.getElementById('editCisGroupModal').style.display = 'none';
                loadCisGroups();
                loadTopology(); // Refresh topology to reflect changes
            } catch (error) {
                showNotification('Failed to update CIS group', 'error');
            }
        }
        
        async function deleteEnvironment(envId) {
            if (!confirm('Are you sure you want to delete this environment?')) {
                return;
            }
            
            try {
                await apiCall(`/api/environments/${envId}`, {
                    method: 'DELETE'
                });
                
                showNotification('Environment deleted successfully!');
                loadEnvironments();
            } catch (error) {
                console.error('Delete environment error:', error);
                console.error('Error message:', error.message);
                
                // Extract error message from response if available
                let errorMessage = 'Failed to delete environment';
                if (error.message) {
                    errorMessage = error.message;
                }
                showNotification(errorMessage, 'error');
            }
        }
        
        async function deleteCisGroup(groupId) {
            if (!confirm('Are you sure you want to delete this CIS group?')) {
                return;
            }
            
            try {
                console.log('Attempting to delete CIS group:', groupId);
                await apiCall(`/api/cis-groups/${groupId}`, {
                    method: 'DELETE'
                });
                
                showNotification('CIS Group deleted successfully!');
                loadCisGroups();
            } catch (error) {
                console.error('Delete CIS group error:', error);
                console.error('Error message:', error.message);
                console.error('Error status:', error.status);
                console.error('Full error object:', JSON.stringify(error, null, 2));
                
                // Extract error message from response if available
                let errorMessage = 'Failed to delete CIS group';
                if (error.message) {
                    errorMessage = error.message;
                }
                console.log('Showing notification with message:', errorMessage);
                showNotification(errorMessage, 'error');
            }
        }
        
        function exportJson() {
            window.open('/api/export/json', '_blank');
        }
        
        function exportJsonl() {
            window.open('/api/export/jsonl', '_blank');
        }
    </script>
</body>
</html>